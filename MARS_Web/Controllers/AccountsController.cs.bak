using MARS_Revamp_DB.Entities;
using MARS_Repository.Repositories;
using MARS_Repository.ViewModel;
using MARS_Web.Helper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace MARS_Web.Controllers
{
    public class AccountsController : Controller
    {

        // GET: Accounts        
        public ActionResult ListOfUsers()
        {
            return View();
        }

        [HttpPost]
        public JsonResult DataLoad()
        {
            try
            {
                var repAcc = new AccountRepository();

                string search = Request.Form.GetValues("search[value]")[0];
                string draw = Request.Form.GetValues("draw")[0];
                string order = Request.Form.GetValues("order[0][column]")[0];
                string orderDir = Request.Form.GetValues("order[0][dir]")[0];
                int startRec = Convert.ToInt32(Request.Form.GetValues("start")[0]);
                int pageSize = Convert.ToInt32(Request.Form.GetValues("length")[0]);

                var data = new List<UserModel>();

                data = repAcc.ListAllUsers().ToList();

                string LastNameSearch = Request.Form.GetValues("columns[0][search][value]")[0];
                string MiddelNameSearch = Request.Form.GetValues("columns[1][search][value]")[0];
                string FirstNameSearch = Request.Form.GetValues("columns[2][search][value]")[0];
                string UserNameSearch = Request.Form.GetValues("columns[3][search][value]")[0];
                string EmailSearch = Request.Form.GetValues("columns[4][search][value]")[0];
                string CompanySearch = Request.Form.GetValues("columns[5][search][value]")[0];

                string colOrderIndex = Request.Form.GetValues("order[0][column]")[0];
                var colOrder = Request.Form.GetValues("columns[" + colOrderIndex + "][name]").FirstOrDefault();
                string colDir = Request.Form.GetValues("order[0][dir]")[0];


                if (!string.IsNullOrEmpty(LastNameSearch))
                {
                    data = data.Where(x => x.TESTER_NAME_LAST.ToLower().Trim().Contains(LastNameSearch.ToLower().Trim())).ToList();
                }
                if (!string.IsNullOrEmpty(MiddelNameSearch))
                {
                    data = data.Where(p => p.TESTER_NAME_M.ToString().ToLower().Contains(MiddelNameSearch.ToLower())).ToList();
                }
                if (!string.IsNullOrEmpty(FirstNameSearch))
                {
                    data = data.Where(x => x.TESTER_NAME_F.ToLower().Trim().Contains(FirstNameSearch.ToLower().Trim())).ToList();
                }
                if (!string.IsNullOrEmpty(UserNameSearch))
                {
                    data = data.Where(x => x.TESTER_LOGIN_NAME.ToLower().Trim().Contains(UserNameSearch.ToLower().Trim())).ToList();
                }
                if (!string.IsNullOrEmpty(EmailSearch))
                {
                    data = data.Where(x => x.TESTER_MAIL.ToLower().Trim().Contains(EmailSearch.ToLower().Trim())).ToList();
                }
                if (!string.IsNullOrEmpty(CompanySearch))
                {
                    data = data.Where(x => x.COMPANY_NAME.ToLower().Trim().Contains(CompanySearch.ToLower().Trim())).ToList();
                }

                if (colDir == "desc")
                {
                    switch (colOrder)
                    {
                        case "Last Name":
                            data = data.OrderByDescending(a => a.TESTER_NAME_LAST).ToList();
                            break;
                        case "Middle Name":
                            data = data.OrderByDescending(a => a.TESTER_NAME_M).ToList();
                            break;
                        case "First Name":
                            data = data.OrderByDescending(a => a.TESTER_NAME_F).ToList();
                            break;
                        case "User Name":
                            data = data.OrderByDescending(a => a.TESTER_LOGIN_NAME).ToList();
                            break;
                        case "Email Address":
                            data = data.OrderByDescending(a => a.TESTER_MAIL).ToList();
                            break;
                        case "Company Name":
                            data = data.OrderByDescending(a => a.COMPANY_NAME).ToList();
                            break;
                        default:
                            data = data.OrderByDescending(a => a.TESTER_NAME_LAST).ToList();
                            break;
                    }

                }
                else
                {
                    switch (colOrder)
                    {
                        case "Last Name":
                            data = data.OrderBy(a => a.TESTER_NAME_LAST).ToList();
                            break;
                        case "Middle Name":
                            data = data.OrderBy(a => a.TESTER_NAME_M).ToList();
                            break;
                        case "First Name":
                            data = data.OrderBy(a => a.TESTER_NAME_F).ToList();
                            break;
                        case "User Name":
                            data = data.OrderBy(a => a.TESTER_LOGIN_NAME).ToList();
                            break;
                        case "Email Address":
                            data = data.OrderBy(a => a.TESTER_MAIL).ToList();
                            break;
                        case "Company Name":
                            data = data.OrderBy(a => a.COMPANY_NAME).ToList();
                            break;
                        default:
                            data = data.OrderBy(a => a.TESTER_NAME_LAST).ToList();
                            break;
                    }

                }

                int totalRecords = data.Count();
                if (!string.IsNullOrEmpty(search) &&
                !string.IsNullOrWhiteSpace(search))
                {
                    // Apply search   
                    data = data.Where(p => p.COMPANY_NAME.ToString().ToLower().Contains(search.ToLower())).ToList();
                }

                int recFilter = data.Count();
                data = data.Skip(startRec).Take(pageSize).ToList();


                return Json(new
                {
                    draw = Convert.ToInt32(draw),
                    recordsTotal = totalRecords,
                    recordsFiltered = recFilter,
                    data = data
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult AddEditUser(int? lid)
        {
            ViewBag.Header = "Add User";
            var repCompany = new CompanyRepository();
            var Accountrepo = new AccountRepository();
            var lModel = new T_TESTER_INFO();
            var lCompanyList = repCompany.GetCompanyList();
            var companylist = lCompanyList.Select(c => new SelectListItem { Text = c.COMPANY_NAME, Value = c.COMPANY_ID.ToString() }).ToList();
            ViewBag.listCompany = companylist;
            if (lid != null)
            {
                lModel = Accountrepo.GetUserById((Int32)lid);
                ViewBag.Header = "Edit User";
            }
            return View(lModel);
        }
        
        [HttpPost]
        public JsonResult AddEditUser(T_TESTER_INFO t_TESTER)
        {
            ViewBag.Header = "Edit User";
            var Accountrepo = new AccountRepository();
            var repCompany = new CompanyRepository();
            var lCompanyList = repCompany.GetCompanyList();
            var companylist = lCompanyList.Select(c => new SelectListItem { Text = c.COMPANY_NAME, Value = c.COMPANY_ID.ToString() }).ToList();
            ViewBag.listCompany = companylist;            
            if (t_TESTER.TESTER_ID == 0)
            {
                t_TESTER.TESTER_PWD = PasswordHelper.EncodeString(t_TESTER.TESTER_PWD);
                ViewBag.Header = "Add User";
            }
            t_TESTER = Accountrepo.CreateNewUser(t_TESTER);
            Session["SubmitUserMsg"] = "Succefully Submitted User.";

            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult CheckLoginNameExist(string lLoginName, int? lLoginId)
        {
            AccountRepository Accountrepo = new AccountRepository();
            var lflag = Accountrepo.CheckLoginNameExist(lLoginName, lLoginId);
            return Json(lflag, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult CheckEmailExist(string lLoginEmail, int? lLoginId)
        {
            AccountRepository Accountrepo = new AccountRepository();
            var lflag = Accountrepo.CheckLoginEmailExist(lLoginEmail, lLoginId);
            return Json(lflag, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult ChangeUserPassowrd(string lOldPsw,string lNewPsw,int lUserId)
        {
            AccountRepository Accountrepo = new AccountRepository();
            string lMsg = "Old Password Not Matched.";
            var lUser = Accountrepo.GetUserById(lUserId);
            var lOldPassword = PasswordHelper.DecodeString(lUser.TESTER_PWD);

            if (lOldPsw == lOldPassword)
            {
                lNewPsw = PasswordHelper.EncodeString(lNewPsw);
                var lflag = Accountrepo.ChangeUserPassword(lNewPsw, (decimal)lUserId);
                lMsg = "Succefully Updated New Password";
            }
            
            return Json(lMsg, JsonRequestBehavior.AllowGet);
        }
    }
}