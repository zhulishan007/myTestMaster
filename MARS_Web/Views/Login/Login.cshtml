@using System.Configuration;
@{
    Layout = null;
    var WebAPIURL = ConfigurationManager.AppSettings["WebApiURL"];
}

<!DOCTYPE html>

<html lang="en">
<!-- begin::Head -->
<head>
    <base href="../../../">
    <meta charset="utf-8" />
    <title>Mars login</title>
    <meta name="description" content="Login page example">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--begin::Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700|Roboto:300,400,500,600,700">
    <!--end::Fonts -->
    <!--begin::Page Custom Styles(used by this page) -->
    <link href="~/assets/css/pages/login/login-2.css" rel="stylesheet" type="text/css" />
    <!--end::Page Custom Styles -->
    <!--begin::Global Theme Styles(used by all pages) -->
    <link href="~/assets/plugins/global/plugins.bundle.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/style.bundle.css" rel="stylesheet" type="text/css" />
    <!--end::Global Theme Styles -->
    <!--begin::Layout Skins(used by all pages) -->
    <link href="~/assets/css/skins/header/base/light.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/skins/header/menu/light.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/skins/brand/dark.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/skins/aside/dark.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/custom.css" rel="stylesheet" />
    <!--end::Layout Skins -->
    @*<link rel="shortcut icon" href="~/assets/media/logos/favicon.ico" />*@
    <script src="~/Scripts/jquery-3.3.1.min.js"></script>
</head>
<!-- end::Head -->
<!-- begin::Body -->
<body class="kt-quick-panel--right kt-demo-panel--right kt-offcanvas-panel--right kt-header--fixed kt-header-mobile--fixed kt-subheader--enabled kt-subheader--fixed kt-subheader--solid kt-aside--enabled kt-aside--fixed kt-page--loading" style="background-image: url(assets/media/login/login-4-bg.jpg);background-repeat: no-repeat; background-size: cover; background-position: bottom;">
    <!-- begin:: Page -->
    <div class="lds-roller" style="z-index:2">
        <img src="/assets/media/mars.gif" style="width:80px;" />
    </div>
    @*<div style="background-image: url(assets/media/login/login-4-bg.jpg);background-repeat: no-repeat; background-size: cover; background-position: bottom;" class="kt-grid kt-grid--ver kt-grid--root kt-page">*@
    <div class="kt-grid kt-grid--ver kt-grid--root kt-page">
        <div class="kt-grid kt-grid--hor kt-grid--root kt-login kt-login--v2 kt-login--signin" id="kt_login">
            <div class="kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor">
                <div class="kt-grid__item kt-grid__item--fluid kt-login__wrapper">
                    <div class="kt-login__container">
                        <div class="kt-login__logo">
                            <a href="#">
                                @*<img src="assets/media/company-logos/logo-2.png">*@
                                <img src="~/assets/media/Logo/MARS_LOGO.png" style="height:105px" />
                            </a>
                        </div>
                        <div class="kt-login__signin kt-form">
                            <div class="kt-login__head">
                                <h3 class="kt-login__title">Sign In</h3>
                            </div>
                            <div class="input-group wrap-input100">
                                <input class="form-control input100" type="text" placeholder="Email" id="email" name="TESTER_MAIL" autocomplete="off">
                                <span class="focus-input100"></span>
                                <span class="symbol-input100">
                                    <i class="fa fa-envelope" aria-hidden="true"></i>
                                </span>
                            </div>
                            <label id="Emailvalidate" class="error" style="display: none;width: 100%;margin-top: 0.25rem;font-size: 80%;color: #fd397a;margin-left: 25px;">
                                This field is required.
                            </label>
                            <div class="input-group wrap-input100">
                                <input class="form-control  input100" type="Password" placeholder="Password" id="password" name="password">
                                <span class="focus-input100"></span>
                                <span class="symbol-input100">
                                    <i class="fa fa-lock" aria-hidden="true"></i>
                                </span>
                            </div>
                            <label id="Passwordvalidate" class="error" style="display: none;width: 100%;margin-top: 0.25rem;font-size: 80%;color: #fd397a;margin-left: 25px;">
                                This field is required.
                            </label>
                            <div class="input-group wrap-input100">
                                <select class="form-control input100" id="DrpDataConn" name="DrpDataConn">
                                    @{var lconnlist = ViewBag.connlist as IEnumerable<SelectListItem>;

                                        foreach (var item in lconnlist)
                                        {
                                            <option value="@item.Value" @(item.Text.Contains(ViewBag.defaultDb) ? "selected" : "")>@item.Text</option>
                                        }
                                    }
                                </select>
                                <span class="focus-input100"></span>
                                <span class="symbol-input100">
                                    <i class="fa fa-database" aria-hidden="true"></i>
                                </span>
                            </div>
                            <div class="row kt-login__extra">
                                <div class="col">
                                    <label class="kt-checkbox">
                                        <input type="checkbox" name="remember" id="chkRememberMe"> Remember me
                                        <span></span>
                                    </label>
                                </div>
                                <div class="col kt-align-right">
                                    <a href="javascript:;" id="kt_login_forgot" class="kt-link kt-login__link">Forgot Password ?</a>
                                </div>
                            </div>
                            <div class="kt-login__actions">
                                <button id="kt_login_signin_submit_In" class="btn btn-pill kt-login__btn-primary">Sign In</button>
                            </div>
                        </div>
                        <div class="kt-login__forgot">
                            <div class="kt-login__head">
                                <h3 class="kt-login__title">Forgotten Password ?</h3>
                                <div class="kt-login__desc">Enter your email to reset your password:</div>
                            </div>
                            <form class="kt-form" action="" id="frmpassword">
                                <div class="input-group wrap-input100">
                                    <input class="form-control input100" type="text" placeholder="Email" nname="email" id="kt_email" autocomplete="off" required>
                                    <span class="focus-input100"></span>
                                    <span class="symbol-input100">
                                        <i class="fa fa-envelope" aria-hidden="true"></i>
                                    </span>
                                </div>
                                <div class="input-group wrap-input100">
                                    <select class="form-control input100" id="DrpFPDataConn" name="DrpFPDataConn">
                                        @{var lconlist = ViewBag.connlist as IEnumerable<SelectListItem>;

                                            foreach (var item in lconlist)
                                            {
                                                <option value="@item.Value" @(item.Text.Contains(ViewBag.defaultDb) ? "selected" : "")>@item.Text</option>
                                            }
                                        }
                                    </select>
                                    <span class="focus-input100"></span>
                                    <span class="symbol-input100">
                                        <i class="fa fa-database" aria-hidden="true"></i>
                                    </span>
                                </div>
                                <div class="kt-login__actions">
                                    <button id="kt_login_forgot_submit" class="btn btn-pill kt-login__btn-primary">Request</button>&nbsp;&nbsp;
                                    <button id="kt_login_forgot_cancel" class="btn btn-pill kt-login__btn-secondary">Cancel</button>
                                </div>
                            </form>
                        </div>
                        <!--<div class="kt-login__account">
                            <span class="kt-login__account-msg">
                                Don't have an account yet ?
                            </span>&nbsp;&nbsp;
                            <a href="javascript:;" id="kt_login_signup" class="kt-link kt-link--light kt-login__account-link">Sign Up</a>
                        </div>-->
                    </div>
                </div>
                <p class="login_copyright">© All rights reserved by <a href="#">Marquis Business & Technology Solutions</a>, 2020</p>
            </div>
        </div>
    </div>
    <!-- end:: Page -->
    <!-- begin::Global Config(global config for global JS sciprts) -->
    <script>
        var accesstoken = "";
        var KTAppOptions = {
            "colors": {
                "state": {
                    "brand": "#5d78ff",
                    "dark": "#282a3c",
                    "light": "#ffffff",
                    "primary": "#5867dd",
                    "success": "#34bfa3",
                    "info": "#36a3f7",
                    "warning": "#ffb822",
                    "danger": "#fd3995"
                },
                "base": {
                    "label": [
                        "#c5cbe3",
                        "#a1a8c3",
                        "#3d4465",
                        "#3e4466"
                    ],
                    "shape": [
                        "#f0f3ff",
                        "#d9dffa",
                        "#afb4d4",
                        "#646c9a"
                    ]
                }
            }
        };
        var login = $('#kt_login');
        var displaySignInForm = function () {
            login.removeClass('kt-login--forgot');
            login.removeClass('kt-login--signup');
            login.addClass('kt-login--signin');
            KTUtil.animateClass(login.find('.kt-login__signin')[0], 'flipInX animated');
        }
        $("#kt_login_forgot_submit").click(function () {
            if ($("#frmpassword").valid()) {

                var btn = $(this);
                var form = $(this).closest('form');
                var lEmail = $("#kt_email").val();
                var lconnection = $("#DrpFPDataConn").val();
                $.ajax({
                    url: "/Login/ForgotPsw",
                    data: '{"lEmail":"' + lEmail + '","lConnection":"' + lconnection + '"}',
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {
                        if (result.status == 1) {
                            if (result.message == "Succefully password sent in your email.") {
                                var type = "success";
                                var showErrorMsg = function (form, type, msg) {
                                    var alert = $('<div class="alert alert-' + type + ' alert-dismissible" role="alert" style="background-color:rgba(28, 96, 129,0.8)">\
                                                            <div class="alert-text">'+ msg + '</div>\
                                                            <div class="alert-close">\
                                                            <i class="flaticon2-cross kt-icon-sm" data-dismiss="alert"></i>\
                                                             </div>\
                                                            </div>');

                                    form.find('.alert').remove();
                                    alert.prependTo(form);
                                    KTUtil.animateClass(alert[0], 'fadeIn animated');
                                    alert.find('span').html(msg);
                                }
                                setTimeout(function () {
                                    btn.removeClass('kt-spinner kt-spinner--right kt-spinner--sm kt-spinner--light').attr('disabled', false); // remove
                                    form.clearForm(); // clear form
                                    form.validate().resetForm(); // reset validation states
                                    displaySignInForm();
                                    var signInForm = login.find('.kt-login__signin');
                                    signInForm.clearForm;
                                    showErrorMsg(signInForm, 'success', 'Cool! Password recovery instruction has been sent to your email.');
                                }, 2000);
                            }
                            else {
                                var type = "error";
                                var showErrorMsg = function (form, type, msg) {
                                    var alert = $('<div class="alert alert-' + type + ' alert-dismissible" role="alert" style="background-color:#ffdada">\
                                                            <div class="alert-text">'+ msg + '</div>\
                                                            <div class="alert-close">\
                                                            <i class="flaticon2-cross kt-icon-sm" data-dismiss="alert"></i>\
                                                             </div>\
                                                            </div>');

                                    form.find('.alert').remove();
                                    alert.prependTo(form);
                                    KTUtil.animateClass(alert[0], 'fadeIn animated');
                                    alert.find('span').html(msg);
                                }
                                setTimeout(function () {
                                    btn.removeClass('kt-spinner kt-spinner--right kt-spinner--sm kt-spinner--light').attr('disabled', false); // remove
                                    form.clearForm(); // clear form
                                    form.validate().resetForm(); // reset validation states
                                    displaySignInForm();
                                    var signInForm = login.find('.kt-login__signin');
                                    signInForm.clearForm;
                                    showErrorMsg(signInForm, 'error', 'Oops! ' + result.message);
                                }, 2000);
                            }
                        }
                        else if (result.status == 0) {
                            swal.fire({
                                "title": "",
                                "text": result.message,
                                "icon": "error",
                                "onClose": function (e) {
                                    console.log('on close event fired!');
                                }
                            });
                        }
                    },
                });
            }
        });

        $(document).ready(function () {
            $("#frmlogin").validate({
                rules: {
                    TESTER_MAIL: {
                        required: true,

                    },
                    password: {
                        required: true
                    },
                },

                invalidHandler: function (event, validator) {
                    swal.fire({
                        "title": "",
                        "text": "There are some invalid entries. Please correct and submit again.",
                        "icon": "error",
                        "confirmButtonClass": "btn btn-secondary",
                        "onClose": function (e) {
                            console.log('on close event fired!');
                        }
                    });

                    event.preventDefault();
                },
            });

        });

        function keypressHandler(e) {
            if (e.which == 13) {
                e.preventDefault();
                $(this).blur();
                $('#kt_login_signin_submit_In').focus().click();
            }
        }
        $('body').keypress(keypressHandler);

        $("#kt_login_signin_submit_In").click(function () {
            startloader();
            $("#kt_login_signin_submit_In").prop("disabled", true);
            var lEmail = $("#email").val();
            var lPassword = $("#password").val();
            var lconnection = $("#DrpDataConn").val();
            var connList = lconnection.split('/');
            var lChkRememberMe = false;
            if ($("#chkRememberMe").is(":checked"))
                lChkRememberMe = true;

            if (lEmail == "" && lPassword == "") {
                $("#Emailvalidate").css("display", "block");
                $("#Passwordvalidate").css("display", "block");
                $("#kt_login_signin_submit_In").prop("disabled", false);
                stoploader();
                return;
            }
            else if (lEmail == "") {
                $("#Emailvalidate").css("display", "block");
                $("#kt_login_signin_submit_In").prop("disabled", false);
                stoploader();
                return;
            }
            else if (lPassword == "") {
                $("#Passwordvalidate").css("display", "block");
                $("#kt_login_signin_submit_In").prop("disabled", false);
                stoploader();
                return;
            }
            else {
                var data = {
                    "grant_type": "password",
                    "username": lEmail,
                    "password": lPassword,
                    "Scope": connList[0],
                };
                $.ajax({
                   url: "@WebAPIURL/api/token",
                    data: data,
                    type: "POST",
                    success: function (data) {
                        accesstoken = data.access_token;
                        if (accesstoken != "") {
                            $.ajax({
                                url: "/Login/Login",
                                data: { lUserLogin: lEmail, lPassword: lPassword, lconnection: lconnection, lRememberme: lChkRememberMe, accesstoken: accesstoken },
                                type: "POST",
                                headers: getHeader(),
                                dataType: "json",
                                success: function (result) {
                                    if (result.status == 0) {
                                            $("#kt_login_signin_submit_In").prop("disabled", false);
                                            stoploader();
                                            var type = "error";
                                            swal.fire({
                                                "title": "",
                                                "text": result.message,
                                                "icon": type,
                                                "onClose": function (e) {
                                                    console.log('on close event fired!');
                                                }
                                            });
                                    }
                                    else if (result.status == 1){
                                            stoploader();
                                            window.location.href = "/Home/Index";
                                        }
                                },
                            });
                        }
                    },
                    error: function (requestObject, error, errorThrown) {
                        $.ajax({
                            url: "/Login/CheckUserExist",
                            data: { lUserLogin: lEmail, lPassword: lPassword, lconnection: connList[0] },
                            type: "POST",
                            dataType: "json",
                            success: function (result) {
                                if (result.status == 1) {
                                    $("#kt_login_signin_submit_In").prop("disabled", false);
                                    stoploader();
                                    var type = "error";
                                    swal.fire({
                                        "title": "",
                                        "text": result.message,
                                        "icon": type,
                                        "onClose": function (e) {
                                            console.log('on close event fired!');
                                        }
                                    });
                                }
                                else if (result.status == 0) {
                                    swal.fire({
                                        "title": "",
                                        "text": result.message,
                                        "icon": "error",
                                        "onClose": function (e) {
                                            console.log('on close event fired!');
                                        }
                                    });
                                }
                            },
                        });
                    }
                });
            }
        });

        function getHeader() {
            if (accesstoken) {
                return { "Authorization": "Bearer " + accesstoken };
            }
        }

        $('#email').on('keyup', function () {
            if ($("#email").val() != "") {
                $("#Emailvalidate").css("display", "none");
                return false;
            }
            else {
                $("#Emailvalidate").css("display", "block");
            }
        });
        $('#password').on('keyup', function () {
            if ($("#password").val() != "") {
                $("#Passwordvalidate").css("display", "none");
                return false;
            }
            else {
                $("#Passwordvalidate").css("display", "block");
            }
        });

        function startloader() {
            $("body").css("pointer-events", "none");
            $(".lds-roller").css("display", "inline-block");
            $("#mainbody").css("opacity", "0.5");
            $("#mainbody").css("z-index", "-1");
        }

        function stoploader() {
            $("body").css("pointer-events", "visible");
            $(".lds-roller").css("display", "none");
            $("#mainbody").css("opacity", "1");
            $("#mainbody").css("z-index", "1");
        }
    </script>
    <!-- end::Global Config -->
    <!--begin::Global Theme Bundle(used by all pages) -->
    <script src="~/assets/plugins/global/plugins.bundle.js" type="text/javascript"></script>
    <script src="~/assets/js/scripts.bundle.js" type="text/javascript"></script>
    <!--end::Global Theme Bundle -->
    <!--begin::Page Scripts(used by this page) -->
    <script src="~/assets/js/pages/custom/login/login-general.js" type="text/javascript"></script>
    <!--end::Page Scripts -->


    @{
        if (Session["ResetSuccessMsg"] != null)
        {
            var lMsg = Session["ResetSuccessMsg"] as string;
            if (!string.IsNullOrEmpty(lMsg))
            {
                <script>
                setTimeout(function () {
                    swal.fire({
                        "title": "",
                        "text": "@lMsg",
                        "icon": "success",
                        "onClose": function (e) {
                            console.log('on close event fired!');
                        }
                    });
                }, 1000);

                </script>
                Session["ResetSuccessMsg"] = "";
            }
        }

    }
</body>
<!-- end::Body -->
</html>