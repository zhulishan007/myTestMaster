@model MARS_Revamp_DB.Entities.T_TESTER_INFO
@*@model Mars_Data.Models.T_MARS_COMPANY*@

@{
    ViewBag.Title = "AddUser";
    Layout = "~/Views/Shared/_Layout.cshtml";

    decimal lEdit = 0;
    var divclass = "col-lg-12";
    if(Model != null)
    {
        lEdit = Model.TESTER_ID;
        if(lEdit > 0)
        {
            divclass = "col-lg-6";
        }
    }
}
@*@{ SelectList Companylist = (SelectList)ViewBag.listCompany; }*@
<div class="kt-content  kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor" id="kt_content">
    <div class="kt-container  kt-container--fluid  kt-grid__item kt-grid__item--fluid">
        <div class="row">
            <div class="@divclass">

                <div class="kt-portlet">
                    <div class="kt-portlet__head">
                        <div class="kt-portlet__head-label">
                            <h3>
                                @ViewBag.Header
                            </h3>
                        </div>
                    </div>
                    <!--begin::Form-->
                    <form class="kt-form kt-form--label-right" id="kt_form_2" name="registration">
                        <div class="kt-portlet__body">
                            <div class="form-group form-group-last kt-hide">
                                <div class="alert alert-danger" role="alert" id="kt_form_2">
                                    <div class="alert-icon"><i class="flaticon-warning"></i></div>
                                    <div class="alert-text">
                                        O h snap! Change a few things up and try submitting again.
                                    </div>
                                    <div class="alert-close">
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true"><i class="la la-close"></i></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            @Html.HiddenFor(x => x.TESTER_ID)
                            <div class="form-group row">
                                <label class="col-form-label col-lg-3 col-sm-12">First Name</label>
                                <div class="col-lg-9 col-md-9 col-sm-12">
                                    @Html.TextBoxFor(m => m.TESTER_NAME_F, new { @class = "form-control", @id = "Firstname", @required = "required" })
                                </div>
                            </div>


                            <div class="form-group row">
                                <label class="col-form-label col-lg-3 col-sm-12">Middle Name</label>
                                <div class="col-lg-9 col-md-9 col-sm-12">
                                    @Html.TextBoxFor(m => m.TESTER_NAME_M, new { @class = "form-control", @id = "Middlename" })
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-form-label col-lg-3 col-sm-12">Last Name</label>
                                <div class="col-lg-9 col-md-9 col-sm-12">
                                    @Html.TextBoxFor(m => m.TESTER_NAME_LAST, new { @class = "form-control", @id = "LastName" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-form-label col-lg-3 col-sm-12">Company Name</label>
                                <div class="col-lg-9 col-md-9 col-sm-12">


                                    @Html.DropDownListFor(model=>model.COMPANY_ID, ViewBag.listCompany as IEnumerable<SelectListItem>,"--Select--",
                                        new {@id= "COMPANY_ID",
                                            @class = "form-control" })
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-form-label col-lg-3 col-sm-12">Email Address</label>
                                <div class="col-lg-9 col-md-9 col-sm-12">
                                    @Html.TextBoxFor(m => m.TESTER_MAIL, new { @class = "form-control", @id = "EmailId", @required = "required", @onchange = "CheckEmailExist()" })
                                    <div id="EmailExisterror" class="error" style="display: none;width: 100%;margin-top: 0.25rem;font-size: 80%;color: #fd397a;">Email already exist.</div>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-form-label col-lg-3 col-sm-12">User Name</label>
                                <div class="col-lg-9 col-md-9 col-sm-12">
                                    @Html.TextBoxFor(m => m.TESTER_LOGIN_NAME, new { @class = "form-control", @id = "Username", @required = "required", @onchange = "CheckLoginNameExist()" })
                                    <div id="Existerror" class="error" style="display: none;width: 100%;margin-top: 0.25rem;font-size: 80%;color: #fd397a;">User Name already exist.</div>
                                </div>
                            </div>

                            @if (!(Model.TESTER_ID > 0))
                            {
                                <div class="form-group row">
                                    <label class="col-form-label col-lg-3 col-sm-12">Password</label>
                                    <div class="col-lg-9 col-md-9 col-sm-12">
                                        @Html.PasswordFor(m => m.TESTER_PWD, new { @class = "form-control", @id = "Password", @required = "required" })
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-form-label col-lg-3 col-sm-12">Confirm Password</label>
                                    <div class="col-lg-9 col-md-9 col-sm-12">
                                        <input type="text" class="form-control" name="cpassword" id="cpassword">
                                    </div>
                                </div>
                            }



                        </div>
                        <div class="kt-portlet__foot">
                            <div class="kt-form__actions">
                                <div class="row">
                                    <div class="col-lg-9 ml-lg-auto">
                                        @if (Model.TESTER_ID > 0)
                                        {
                                            <button type="submit" class="btn btn-outline-brand btn-elevate btn-pill" id="btnAdd">Update</button>
                                        }
                                        else
                                        {
                                            <button type="submit" class="btn btn-outline-brand btn-elevate btn-pill" id="btnAdd">Create</button>
                                        }
                                        <button type="reset" class="btn btn-outline-brand btn-elevate btn-pill" onclick="window.location.href='@Url.Action("ListOfUsers","Accounts")';">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <!--end::Form-->
                </div>

            </div>
            @if (Model.TESTER_ID > 0)
            {

                <div class="col-lg-6">
                    <div class="kt-portlet">
                        <div class="kt-portlet__head">
                            <div class="kt-portlet__head-label">
                                <h3>
                                    Change Password
                                </h3>
                            </div>
                        </div>
                        <!--begin::Form-->
                        <form class="kt-form kt-form--label-right" id="frmpassword" name="frmpassword" >
                            <div class="kt-portlet__body">
                                <div class="form-group form-group-last kt-hide">
                                    <div class="alert alert-danger" role="alert" id="kt_form_2">
                                        <div class="alert-icon"><i class="flaticon-warning"></i></div>
                                        <div class="alert-text">
                                            O h snap! Change a few things up and try submitting again.
                                        </div>
                                        <div class="alert-close">
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true"><i class="la la-close"></i></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                @Html.HiddenFor(x => x.TESTER_ID , new { @id="hdnTesterId"})
                                <div class="form-group row">
                                    <label class="col-form-label col-lg-3 col-sm-12">Old Password</label>
                                    <div class="col-lg-9 col-md-9 col-sm-12">
                                        <input type="password" class="form-control" name="oldPassword" id="oldPassword">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-form-label col-lg-3 col-sm-12">Password</label>
                                    <div class="col-lg-9 col-md-9 col-sm-12">
                                        <input type="password" class="form-control" name="newPassword" id="newPassword">
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-form-label col-lg-3 col-sm-12">Confirm Password</label>
                                    <div class="col-lg-9 col-md-9 col-sm-12">
                                        <input type="text" class="form-control" name="cPassword" id="cPassword">
                                    </div>
                                </div>
                            </div>
                            <div class="kt-portlet__foot">
                                <div class="kt-form__actions">
                                    <div class="row">
                                        <div class="col-lg-9 ml-lg-auto">
                                            <button type="button" class="btn btn-outline-brand btn-elevate btn-pill" id="btnChangePsw">Update</button>
                                            <button type="reset" class="btn btn-outline-brand btn-elevate btn-pill" onclick="window.location.href='@Url.Action("ListOfUsers", "Accounts")';">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <!--end::Form-->
                    </div>

                </div>
            }
            </div>
    </div>    
</div>
    <script src="~/Scripts/jquery-3.3.1.min.js"></script>
    <script type="text/javascript">




        $(document).ready(function () {



            $("#kt_form_2").validate({
                rules: {
                    TESTER_NAME_F: {
                        required: true
                    },

                    TESTER_MAIL: {
                        required: true,
                        email: true

                    },
                    TESTER_LOGIN_NAME: {
                        required: true
                    },
                    TESTER_PWD: {
                        required: true,
                        minlength: 5,
                    },
                    cpassword: {
                        equalTo: "#Password",
                    },


                },

                invalidHandler: function (event, validator) {
                    swal.fire({
                        "title": "",
                        "text": "There are some errors in your submission. Please correct them.",
                        "type": "error",
                        "confirmButtonClass": "btn btn-secondary",
                        "onClose": function (e) {
                            console.log('on close event fired!');
                        }
                    });

                    event.preventDefault();
                },
            });

            $("#frmpassword").validate({
                rules: {                    
                    oldPassword: {
                        required: true,
                        minlength: 5,
                    },
                    newPassword: {
                        required: true,
                        minlength: 5,
                    },
                    cPassword: {
                        required: true,
                        minlength: 5,
                        equalTo: "#newPassword",
                    },


                },

                invalidHandler: function (event, validator) {
                    swal.fire({
                        "title": "",
                        "text": "There are some errors in your submission. Please correct them.",
                        "type": "error",
                        "confirmButtonClass": "btn btn-secondary",
                        "onClose": function (e) {
                            console.log('on close event fired!');
                        }
                    });

                    event.preventDefault();
                },
            });

            $("#btnAdd").click(function () {

                if ($("#kt_form_2").valid()) {

                    //var User = {
                    //    TESTER_ID: 1,
                    //    TESTER_NAME_LAST: "",
                    //    TESTER_NAME_M: "",
                    //    TESTER_NAME_F: "",
                    //    TESTER_MAIL: "",
                    //    TESTER_LOGIN_NAME: "",
                    //    TESTER_PWD: "",

                    //}

                    var userObj = {};

                    userObj.TESTER_ID = $("#TESTER_ID").val(),
                        userObj.TESTER_NAME_LAST = $("#LastName").val(),
                        userObj.TESTER_NAME_M = $("#Middlename").val(),
                        userObj.TESTER_NAME_F = $("#Firstname").val(),
                        userObj.TESTER_MAIL = $("#EmailId").val(),
                        userObj.TESTER_LOGIN_NAME = $("#Username").val(),
                        userObj.TESTER_PWD = $("#Password").val(),
                        userObj.COMPANY_ID = $("#COMPANY_ID").val()


                    $.ajax({
                        url: "/Accounts/AddEditUser",
                        data: JSON.stringify(userObj),
                        type: "POST",
                        contentType: "application/json;charset=utf-8",
                        dataType: "json",
                        success: function (result) {
                            if (result) {
                                window.location.href = "/Accounts/ListOfUsers";
                            }
                        },
                        error: function (errormessage) {
                            alert(errormessage.responseText);
                        }
                    });
                }
            });

            $("#btnChangePsw").click(function () {
                if ($("#frmpassword").valid()) {
                    var lOldPsw = $("#oldPassword").val();
                    var lNewPsw = $("#newPassword").val();
                    var lUserId = $("#hdnTesterId").val();
                    $.ajax({
                        url: "/Accounts/ChangeUserPassowrd",
                        data: '{"lOldPsw":"' + lOldPsw + '","lNewPsw":"' + lNewPsw + '","lUserId":"' + lUserId + '"}',
                        type: "POST",
                        contentType: "application/json;charset=utf-8",
                        dataType: "json",
                        success: function (result) {
                            var type = "success";
                            if (result == "Old Password Not Matched.") {
                                type = "error";
                            }
                            swal.fire({
                                "title": "",
                                "text": result,
                                "type": type,                              
                                "onClose": function (e) {
                                    console.log('on close event fired!');
                                }
                            });
                        },
                    });
                }
            });
        });

        $("#Username").on('keyup', function () {
            $("#Existerror").css("display", "none");
        });
        $("#EmailId").on('keyup', function () {
            $("#EmailExisterror").css("display", "none");
        });
        function CheckLoginNameExist() {
            var pLoginName = $("#Username").val();
            var TESTER_ID = $("#TESTER_ID").val();

            $.ajax({
                url: "/Accounts/CheckLoginNameExist",
                // data: { 'lLoginName': pLoginName, 'lLoginId': TESTER_ID },
                data: '{"lLoginName":"' + pLoginName + '","lLoginId":"' + TESTER_ID + '"}',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    if (result) {
                        $("#Username").val("");
                        $("#Existerror").css("display", "block");
                    }
                },
            });
        }
        function CheckEmailExist() {

            var pEmail = $("#EmailId").val();
            var TESTER_ID = $("#TESTER_ID").val();

            $.ajax({
                url: "/Accounts/CheckEmailExist",
               // data: { 'lLoginName': pLoginName, 'lLoginId': TESTER_ID },
                data: '{"lLoginEmail":"' + pEmail + '","lLoginId":"' + TESTER_ID + '"}',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    if (result) {
                        $("#EmailId").val("");
                        $("#EmailExisterror").css("display", "block");
                    }
                },
            });
        }
    </script>

    @*<script src="~/assets/plugins/global/plugins.bundle.js" type="text/javascript"></script>
        <script src="~/assets/js/scripts.bundle.js" type="text/javascript"></script>*@
