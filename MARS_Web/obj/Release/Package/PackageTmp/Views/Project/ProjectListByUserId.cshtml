@using MARS_Repository.ViewModel
@model List<ProjectByUser>
    <style>
        .table.projectlist th, .table.projectlist td {
            padding: 0.50rem;
        }
    </style>
@if (Model != null)
{
    <div class="kt-content  kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor" id="kt_content">
        <div class="kt-subheader   kt-grid__item" id="kt_subheader" style="left: @ViewBag.width;">
            <div class="kt-container  kt-container--fluid ">
                <div class="kt-subheader__main">

                    <span class="kt-subheader__separator kt-hidden"></span>
                    <div class="kt-subheader__breadcrumbs">
                        <a href="#" class="kt-subheader__breadcrumbs-home"><i class="flaticon2-settings" style="color:#1c6081"></i></a>
                        <a href="#" class="kt-subheader__breadcrumbs-link" style="color:#1c6081">
                            Project List
                        </a>
                        <i class="fa fa-angle-double-right" style="color:#1c6081"></i>
                        <a href="#" class="kt-subheader__breadcrumbs-link" style="color:#1c6081">
                            &nbsp;
                        </a>


                        <!-- <span class="kt-subheader__breadcrumbs-link kt-subheader__breadcrumbs-link--active">Active link</span> -->
                    </div>
                </div>
            </div>
        </div>
        <div class="kt-container  kt-container--fluid  kt-grid__item kt-grid__item--fluid">
            <div class="kt-portlet kt-portlet--mobile">
                <div class="kt-portlet__head kt-portlet__head--lg">
                    <div class="kt-portlet__head-label">
                        <h3 class="kt-portlet__head-title" style="color:#1582ab">
                            List Of All Projects
                        </h3>
                    </div>
                    <div class="kt-portlet__head-toolbar">
                        <div class="kt-portlet__head-wrapper">
                            <div class="kt-input-icon kt-input-icon--left">
                                <input type="text" class="form-control" placeholder="Search..." id="searchprojects" style="height: 30px;">
                                <span class="kt-input-icon__icon kt-input-icon__icon--left">
                                    <span><i class="la la-search"></i></span>
                                </span>
                            </div>
                            @* <input id="myInput" type="text" placeholder="Search..">*@
                        </div>
                    </div>
                </div>
                <div class="kt-portlet__body" @*style="height:400px;overflow-y:auto;"*@ id="divtableid">
                    <table id="projectdisplaylist" class="table table-striped- table-bordered table-hover table-checkable projectlist" style="display:none;">

                        <tr>
                            <th style="color: #1c6081;background-color: #e9f5ff;font-weight: bold;">Project Name</th>
                            <th hidden="hidden">Id</th>
                        </tr>

                        @foreach (ProjectByUser item in Model)
                        {
                            <tr id="thing-1">
                                @if (item.ProjectExists == true)
                                {
                                    <td><div class="kt-checkbox-list"><label  class="kt-checkbox kt-checkbox--brand"><input type="checkbox" checked="checked" onclick="saveData('@item.ProjectName','@item.ProjectId','@item.userId',$(this))" />@item.ProjectName<span></span></label></div></td>
                                    @*<td hidden="hidden" id="userid">@item.userId</td>*@
                                }
                                else
                                {
                                    <td><div class="kt-checkbox-list"><label class="kt-checkbox kt-checkbox--brand"><input type="checkbox" onclick="saveData('@item.ProjectName','@item.ProjectId','@item.userId',$(this))" />@item.ProjectName<span></span></label></div></td>
                                    @*<td hidden="hidden" id="id">@item.userId</td>*@
                                }
                            </tr>
                            @*<span class="kt-menu__arrow"></span>*@
                        }
                    </table>


                </div>
                <div class="kt-portlet__foot">
                    <div class="kt-form__actions">
                        <div class="row">
                            <div class="col-lg-9 ml-lg-auto">
                                <button type="submit" class="btn btn-outline-brand btn-elevate btn-pill" id="jsondata" data-userprojectid="" onclick="save(jsondata,$(this))">Save</button>
                                <button type="reset" class="btn btn-outline-brand btn-elevate btn-pill">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
<script>
    var ProjectByUser = [];
    var jsonData = "[";
    var dataId;
    $(document).ready(function () {
        var heightprojectdl = $(window).height()-260;
        $("#projectdisplaylist").css("display", "table");
        $("#divtableid").css("height", heightprojectdl); 
        $("#divtableid").css("overflow-y", "auto");
    $("#searchprojects").on("keyup", function () {
      var value = $(this).val().toLowerCase();
      $("#projectdisplaylist tr").filter(function () {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
      });
    });
  });
    function saveData(name, id, userid, obj) {
        
        if (userid == "" || userid == null || userid == undefined) {
            userid = 0;
        }
        //jsonData = "[";
        if (jsonData != "[") {
            jsonData += ",";
        }
        var lcheck = 0;
        if ($(obj).is(":checked")) {
            lcheck = 1;
        }
        $(".btn").attr("data-userprojectid", userid);
        //ProjectByUser.push("ProjectName:" + name + "," + "ProjectId:" + id + "," + "flag:" + lcheck);
        jsonData += '{"ProjectName":"' + name + '",  "ProjectId":"' + id + '", "ProjectExists": "' + lcheck + '"';
        jsonData += "}";
        $("#jsondata").val(jsonData);
        //  save(jsonData);
                }
       function save(jsondata, obj) {
        dataId = $(obj).attr("data-userprojectid");
        if (jsondata.value == "" || jsondata.value == null || jsondata.value == undefined) {
            swal.fire({
                "title": "",
                "text": "Please select/deselect Project/s to save",
                "icon": "warning",
                "onClose": function (e) {
                    console.log('on close event fired!');
                }
            });
            return false;
        }
           var r = jsondata.value;
           r += "]";

           var projectlist = JSON.parse(r);
           
           var prolist = projectlist.map(({ ProjectName }) => ProjectName);
           startloader();
        $.ajax({
            dataType: "json",
            type: "POST",
            async: true,
            url: "/Project/SaveProjectChangesByUser",
            data: { model: r, userid: dataId },
            success: function (result) {
                if (result.status == 1 && result.data == "success") {
                    stoploader();
                    swal.fire({
                        "title": "",
                        "text": "Project [" + prolist +"] is saved",
                        "icon": "success",
                        "onClose": function (e) {
                            console.log('on close event fired!');
                        }
                    });
                   
                    $("#jsondata").val("");
                    jsonData = "[";
                    $.ajax({
                        url: "/Login/LeftPanel",

                        type: "POST",
                        contentType: "application/json;charset=utf-8",
                        dataType: "HTML",
                        success: function (result) {
                            $("#leftProjectList").html("");
                            $("#leftProjectList").html(result);
                            
                            UpTable.table().draw();
                        }
                    });
                }
                else if (result.status == 0) {
                    swal.fire({
                        "title": "",
                        "text": result.message,
                        "icon": "error",
                        "onClose": function (e) {
                            console.log('on close event fired!');
                        }
                    });
                }
            }
        });
    }
</script>
